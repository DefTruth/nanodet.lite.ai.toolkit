# nanodet.lite.ai.toolkit ğŸš€ğŸš€ğŸŒŸ  

<div align='left'>
  <img src=https://img.shields.io/github/stars/DefTruth/nanodet.lite.ai.toolkit.svg?style=social >
  <img src=https://img.shields.io/github/forks/DefTruth/nanodet.lite.ai.toolkit.svg?style=social >
  <img src=https://img.shields.io/github/watchers/DefTruth/nanodet.lite.ai.toolkit.svg?style=social>
  <img src=https://visitor-badge.laobi.icu/badge?page_id=DefTruth.nanodet.lite.ai.toolkit >
</div>


ä½¿ç”¨Lite.AI.ToolKit C++å·¥å…·ç®±æ¥è·‘NanoDetçš„ä¸€äº›æ¡ˆä¾‹(https://github.com/DefTruth/lite.ai.toolkit) ï¼ŒONNXRuntimeã€MNNã€NCNNå’ŒTNNå››ä¸ªç‰ˆæœ¬ã€‚

<div align='center'>
  <img src='resources/1.jpg' height="100px" width="200px">
  <img src='resources/3.jpg' height="100px" width="200px">
  <img src='resources/7.jpg' height="100px" width="200px">
  <img src='resources/9.jpg' height="100px" width="200px">

</div>   

è‹¥æ˜¯æœ‰ç”¨ï¼Œâ¤ï¸ä¸å¦¨ç»™ä¸ªâ­ï¸ğŸŒŸæ”¯æŒä¸€ä¸‹å§~ ğŸ™ƒğŸ¤ªğŸ€

## 2. C++ç‰ˆæœ¬æºç 

nanodet C++ ç‰ˆæœ¬çš„æºç åŒ…å«ONNXRuntimeã€MNNã€NCNNå’ŒTNNå››ä¸ªç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ [lite.ai.toolkit](https://github.com/DefTruth/lite.ai.toolkit) å·¥å…·ç®±ä¸­æ‰¾åˆ°ã€‚æœ¬é¡¹ç›®ä¸»è¦ä»‹ç»å¦‚ä½•åŸºäº [lite.ai.toolkit](https://github.com/DefTruth/lite.ai.toolkit) å·¥å…·ç®±ï¼Œç›´æ¥ä½¿ç”¨nanodetæ¥è·‘ç›®æ ‡æ£€æµ‹ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæœ¬é¡¹ç›®æ˜¯åŸºäºMacOSä¸‹ç¼–è¯‘çš„ [liblite.ai.toolkit.v0.1.0.dylib](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/lite.ai.toolkit/lib) æ¥å®ç°çš„ï¼Œå¯¹äºä½¿ç”¨MacOSçš„ç”¨æˆ·ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½æœ¬é¡¹ç›®åŒ…å«çš„*liblite.ai.toolkit.v0.1.0*åŠ¨æ€åº“å’Œå…¶ä»–ä¾èµ–åº“è¿›è¡Œä½¿ç”¨ã€‚è€ŒéMacOSç”¨æˆ·ï¼Œåˆ™éœ€è¦ä»[lite.ai.toolkit](https://github.com/DefTruth/lite.ai.toolkit) ä¸­ä¸‹è½½æºç è¿›è¡Œç¼–è¯‘ã€‚[lite.ai.toolkit](https://github.com/DefTruth/lite.ai.toolkit) c++å·¥å…·ç®±çš„ç¼–è¯‘å·²ç»åœ¨MacOS/Linux/Windowsä¸‹ç¼–è¯‘æµ‹è¯•é€šè¿‡ï¼Œæ”¯æŒCPUå’ŒGPUç¯å¢ƒï¼Œç›®å‰åŒ…å«70+æµè¡Œçš„å¼€æºæ¨¡å‹ã€‚
* [nanodet.cpp](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/ort/cv/nanodet.cpp)
* [nanodet.h](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/ort/cv/nanodet.h)  
* [mnn_nanodet.cpp](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/mnn/cv/mnn_nanodet.cpp)
* [mnn_nanodet.h](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/mnn/cv/mnn_nanodet.h)
* [tnn_nanodet.cpp](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/tnn/cv/tnn_nanodet.cpp)
* [tnn_nanodet.h](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/tnn/cv/tnn_nanodet.h)
* [ncnn_nanodet.cpp](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/ncnn/cv/ncnn_nanodet.cpp)
* [ncnn_nanodet.h](https://github.com/DefTruth/lite.ai.toolkit/blob/main/lite/ncnn/cv/ncnn_nanodet.h)

ONNXRuntime C++ã€MNNã€TNNå’ŒNCNNç‰ˆæœ¬çš„æ¨ç†å®ç°å‡å·²æµ‹è¯•é€šè¿‡ï¼Œæ¬¢è¿ç™½å«–~

## 3. æ¨¡å‹æ–‡ä»¶

### 3.1 ONNXæ¨¡å‹æ–‡ä»¶
å¯ä»¥ä»æˆ‘æä¾›çš„é“¾æ¥ä¸‹è½½ ([Baidu Drive](https://pan.baidu.com/s/1elUGcx7CZkkjEoYhTMwTRQ) code: 8gin) , ä¹Ÿå¯ä»¥ä»æœ¬ç›´æ¥ä»“åº“ä¸‹è½½ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†ä¾¿äºC++å·¥ç¨‹çš„å®ç°ï¼Œæˆ‘å¯¹nanodetå®˜æ–¹çš„nanodet_head.py å’Œ gfl_head.pyçš„æºç è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ã€‚å¦‚æœä½ æƒ³è¦è‡ªå·±è½¬æ¢onnxæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘forkçš„åˆ†æ”¯ğŸ‘‰[DefTruth/nanodet](https://github.com/DefTruth/nanodet).   


|                 Class                 |      Pretrained ONNX Files      |              Rename or Converted From (Repo)              | Size  |
| :-----------------------------------: | :-----------------------------: | :-------------------------------------------------------: | :---: |  
| *lite::cv::detection::NanoDet* |    [nanodet_m_0.5x.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 1.1Mb  |
| *lite::cv::detection::NanoDet* |    [nanodet_m.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::cv::detection::NanoDet* |    [nanodet_m_1.5x.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::cv::detection::NanoDet* |    [nanodet_m_1.5x_416.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::cv::detection::NanoDet* |    [nanodet_m_416.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::cv::detection::NanoDet* |    [nanodet_g.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 14Mb  |
| *lite::cv::detection::NanoDet* |    [nanodet_t.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 5.1Mb  |
| *lite::cv::detection::NanoDet* |    [nanodet-RepVGG-A0_416.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 26Mb  |
| *lite::cv::detection::NanoDetEfficientNetLite* |    [nanodet-EfficientNet-Lite0_320.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 12Mb  |
| *lite::cv::detection::NanoDetEfficientNetLite* |    [nanodet-EfficientNet-Lite1_416.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 15Mb  |
| *lite::cv::detection::NanoDetEfficientNetLite* |    [nanodet-EfficientNet-Lite2_512.onnx](https://github.com/DefTruth/nanodet.lite.ai.toolkit/blob/main/examples/hub/onnx/cv)     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 18Mb  |  

### 3.2 MNNæ¨¡å‹æ–‡ä»¶ 
MNNæ¨¡å‹æ–‡ä»¶ä¸‹è½½åœ°å€ï¼Œ([Baidu Drive](https://pan.baidu.com/s/1KyO-bCYUv6qPq2M8BH_Okg) code: 9v63)

|                 Class                 |      Pretrained MNN Files      |              Rename or Converted From (Repo)              | Size  |
| :-----------------------------------: | :-----------------------------: | :-------------------------------------------------------: | :---: |
| *lite::mnn::cv::detection::NanoDet* |    nanodet_m_0.5x.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 1.1Mb  |
| *lite::mnn::cv::detection::NanoDet* |    nanodet_m.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::mnn::cv::detection::NanoDet* |    nanodet_m_1.5x.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::mnn::cv::detection::NanoDet* |    nanodet_m_1.5x_416.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::mnn::cv::detection::NanoDet* |    nanodet_m_416.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::mnn::cv::detection::NanoDet* |    nanodet_g.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 14Mb  |
| *lite::mnn::cv::detection::NanoDet* |    nanodet_t.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 5.1Mb  |
| *lite::mnn::cv::detection::NanoDet* |    nanodet-RepVGG-A0_416.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 26Mb  |
| *lite::mnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite0_320.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 12Mb  |
| *lite::mnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite1_416.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 15Mb  |
| *lite::mnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite2_512.mnn     |       [nanodet](https://github.com/RangiLyu/nanodet)

### 3.3 TNNæ¨¡å‹æ–‡ä»¶
TNNæ¨¡å‹æ–‡ä»¶ä¸‹è½½åœ°å€ï¼Œ([Baidu Drive](https://pan.baidu.com/s/1lvM2YKyUbEc5HKVtqITpcw) code: 6o6k)

|                 Class                 |      Pretrained TNN Files      |              Rename or Converted From (Repo)              | Size  |
| :-----------------------------------: | :-----------------------------: | :-------------------------------------------------------: | :---: |
| *lite::tnn::cv::detection::NanoDet* |    nanodet_m_0.5x.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 1.1Mb  |
| *lite::tnn::cv::detection::NanoDet* |    nanodet_m.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::tnn::cv::detection::NanoDet* |    nanodet_m_1.5x.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::tnn::cv::detection::NanoDet* |    nanodet_m_1.5x_416.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::tnn::cv::detection::NanoDet* |    nanodet_m_416.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::tnn::cv::detection::NanoDet* |    nanodet_g.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 14Mb  |
| *lite::tnn::cv::detection::NanoDet* |    nanodet_t.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 5.1Mb  |
| *lite::tnn::cv::detection::NanoDet* |    nanodet-RepVGG-A0_416.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 26Mb  |
| *lite::tnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite0_320.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 12Mb  |
| *lite::tnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite1_416.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 15Mb  |
| *lite::tnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite2_512.opt.tnnproto&tnnmodel     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 18Mb  |

### 3.4 NCNNæ¨¡å‹æ–‡ä»¶  
NCNNæ¨¡å‹æ–‡ä»¶ä¸‹è½½åœ°å€ï¼Œ([Baidu Drive](https://pan.baidu.com/s/1hlnqyNsFbMseGFWscgVhgQ) code: sc7f)

|                 Class                 |      Pretrained NCNN Files      |              Rename or Converted From (Repo)              | Size  |
| :-----------------------------------: | :-----------------------------: | :-------------------------------------------------------: | :---: |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet_m_0.5x-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 1.1Mb  |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet_m-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet_m_1.5x-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet_m_1.5x_416-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet_m_416-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet_g-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 14Mb  |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet_t-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 5.1Mb  |
| *lite::ncnn::cv::detection::NanoDet* |    nanodet-RepVGG-A0_416-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 26Mb  |
| *lite::ncnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite0_320-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 12Mb  |
| *lite::ncnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite1_416-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 15Mb  |
| *lite::ncnn::cv::detection::NanoDetEfficientNetLite* |    nanodet-EfficientNet-Lite2_512-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 18Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet_m_0.5x-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 1.1Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet_m-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet_m_1.5x-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet_m_1.5x_416-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 7.9Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet_m_416-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 3.6Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet_g-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 14Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet_t-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 5.1Mb  |
| *lite::ncnn::cv::detection::NanoDetDepreciated* |    nanodet-RepVGG-A0_416-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 26Mb  |
| *lite::ncnn::cv::detection::NanoDetEfficientNetLiteDepreciated* |    nanodet-EfficientNet-Lite0_320-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 12Mb  |
| *lite::ncnn::cv::detection::NanoDetEfficientNetLiteDepreciated* |    nanodet-EfficientNet-Lite1_416-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 15Mb  |
| *lite::ncnn::cv::detection::NanoDetEfficientNetLiteDepreciated* |    nanodet-EfficientNet-Lite2_512-depreciated-opt.param&bin     |       [nanodet](https://github.com/RangiLyu/nanodet)       | 18Mb  |

## 4. ä¿®æ”¹æºç 

### 4.1 ä¿®æ”¹Internal

åœ¨ğŸ‘‰[DefTruth/nanodet](https://github.com/DefTruth/nanodet) ä¸­æˆ‘æŠŠdistribution_projectéƒ¨åˆ†çš„æ“ä½œä¹Ÿè¿›è¡Œäº†ONNXå¯¼å‡ºï¼Œä¸ºæ­¤ï¼Œæˆ‘å¯¹Internalçš„åŸå§‹å®ç°è¿›è¡Œäº†ä¿®æ”¹ï¼Œä½¿å…¶èƒ½å¤Ÿä¸ONNXçš„ç®—å­å…¼å®¹ã€‚Internalæ•´ä½“çš„æ€è·¯ä¸å˜ï¼Œä½†æˆ‘ä¿®æ”¹äº†`project`çš„bufferæ³¨å†Œéƒ¨åˆ†ï¼ŒåŸæ¥`project`æ³¨å†Œçš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š  
```python
 self.register_buffer(
      "project", torch.linspace(0, self.reg_max, self.reg_max + 1)
 )
```  
è¿™éƒ¨åˆ†ä»£ç æœ‰2ä¸ªå°é—®é¢˜ï¼Œä¼šå¯¼è‡´ONNXå¯¼å‡ºåï¼Œæ— æ³•è¢«ONNXRuntimeåŠ è½½ã€‚å…¶ä¸€æ˜¯ï¼Œtorch.linspaceæ²¡æœ‰è¢«[torch.onnx.export](https://pytorch.org/docs/stable/onnx.html#supported-operators) ç›´æ¥æ”¯æŒï¼Œå¯¼å‡ºåå¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯ã€‚å…¶äºŒæ˜¯ï¼Œ`project`å¹¶æ²¡æœ‰è¢«æ˜¾å¼åœ°æ³¨å†ŒæˆäºŒç»´çš„çŸ©é˜µï¼Œè€Œæ˜¯ä¸€ä¸ªä¸€ç»´å‘é‡ï¼Œè¿™ä¼šå¯¼è‡´è½¬æ¢å‡ºæ¥çš„ONNXæ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œå› ä¸ºå¼ é‡çš„ç»´åº¦æ²¡æœ‰å¯¹é½ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Internalä¸­çš„forwardä½¿ç”¨äº†F.linearï¼š
```python
 x = F.softmax(x.reshape(-1, self.reg_max + 1), dim=1)
 x = F.linear(x, self.project.type_as(x)).reshape(-1, 4)
```  
æŸ¥çœ‹F.linearæ–‡æ¡£ï¼Œè¿™å®é™…ä¸Šæ˜¯åœ¨åšä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜ï¼š  
```python
def linear(input: Tensor, weight: Tensor, bias: Optional[Tensor] = None) -> Tensor:
    r"""
    Applies a linear transformation to the incoming data: :math:`y = xA^T + b`.

    This operator supports :ref:`TensorFloat32<tf32_on_ampere>`.

    Shape:

        - Input: :math:`(N, *, in\_features)` N is the batch size, `*` means any number of
          additional dimensions
        - Weight: :math:`(out\_features, in\_features)`
        - Bias: :math:`(out\_features)`
        - Output: :math:`(N, *, out\_features)`
    """
```
Internalä¸­çš„`project`å°±æ˜¯linearç”¨åˆ°çš„å‚æ•°`Weight`ï¼Œéœ€è¦æ˜¯ä¸€ä¸ªçŸ©é˜µçš„å½¢å¼ã€‚åœ¨PyTorchä¸­ç›´æ¥ä½¿ç”¨ä¸€ç»´å‘é‡æ¥ç›¸ä¹˜ï¼Œä¹Ÿæ²¡æœ‰æŠ¥é”™ï¼Œæˆ‘æƒ³è¿™ä¸»è¦å½’åŠŸäºPyTorchçš„è‡ªåŠ¨broadcaståŠŸèƒ½ï¼Œå®ƒè‡ªèƒ½åœ°æŠŠç»´åº¦å¯¹é½äº†ã€‚ç„¶è€Œï¼Œè¿™ç§broadcastçš„è¡Œä¸ºï¼Œå¹¶æ²¡æœ‰è¢«ONNXå¾ˆå¥½åœ°æ”¯æŒï¼Œåœ¨è½¬æ¢ONNXæ–‡ä»¶åï¼Œå°±ä¼šå‡ºé—®é¢˜ã€‚å› æ­¤ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯å¯¹Internalè¿›è¡Œä¿®æ”¹ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å¸¦å¯å­¦ä¹ å‚æ•°çš„æ“ä½œï¼Œå®Œå…¨å¯ä»¥åŠ¨åˆ€ã€‚
* ä½¿ç”¨torch.arangeæ›¿æ¢torch.linspaceï¼Œtorch.arangeè¢«[torch.onnx.export](https://pytorch.org/docs/stable/onnx.html#supported-operators) ç›´æ¥æ”¯æŒ  
* åœ¨å¯¹`project`è¿›è¡Œbufferæ³¨å†Œæ—¶ï¼Œä½¿ç”¨æ˜¾å¼çš„ç»´åº¦è®¾ç½®ï¼Œè€Œééšå¼çš„ç»´åº¦è®¾ç½®ã€‚  
ä¿®æ”¹åçš„bufferæ³¨å†Œä»£ç å¦‚ä¸‹ï¼š  
  
```python
self.register_buffer(
    "project",
    torch.arange(0, self.reg_max + 1).reshape(1, self.reg_max + 1)
)
```  

### 4.2 å¯¼å‡ºdistribution_project  
ä»€ä¹ˆæ˜¯distribution_projectï¼Ÿè¿™ä¸ªéœ€è¦å°ä¼™ä¼´ä»¬å»çœ‹ä¸€ä¸‹[nanodetä½œè€…çš„è¯¦ç»†è§£æ](https://zhuanlan.zhihu.com/p/306530300) å’Œ [å¤§ç™½è¯ Generalized Focal Loss](https://zhuanlan.zhihu.com/p/147691786) è¿™ä¸¤ç¯‡æ–‡ç« äº†ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œä¸€èˆ¬çš„ç›®æ ‡æ£€æµ‹éƒ½æ˜¯ç›´æ¥å›å½’è¾¹æ¡†ç›¸å¯¹äºæŸä¸ªæŒ‡å®šé•¿åº¦çš„åç§»é‡æˆ–ç›¸å¯¹é‡ï¼Œä½†æ˜¯GFLå’Œnanodetä¸è¿™ä¹ˆå¹²ï¼Œå› ä¸ºè¿™æ ·éå¸¸ä¸flexibleï¼Œåœ¨å¤æ‚åœºæ™¯ä¸­ï¼Œè¾¹ç•Œæ¡†çš„è¡¨ç¤ºå…·æœ‰å¾ˆå¼ºçš„ä¸ç¡®å®šæ€§ï¼Œè€Œç°æœ‰çš„æ¡†å›å½’æœ¬è´¨éƒ½æ˜¯å»ºæ¨¡äº†éå¸¸å•ä¸€çš„ç‹„æ‹‰å…‹åˆ†å¸ƒã€‚GFLçš„ä½œè€…å¸Œæœ›ç”¨ä¸€ç§generalçš„åˆ†å¸ƒå»å»ºæ¨¡è¾¹ç•Œæ¡†çš„è¡¨ç¤ºï¼Œå·¥ç¨‹ä¸Šçš„å®ç°å°±æ˜¯ï¼Œé¢„æµ‹è¾¹æ¡†å¤§å°åœ¨(0,1,2,...,n=7|8|9|...)ä¸Šçš„æ¦‚ç‡åˆ†å¸ƒï¼Œç„¶åå†é‡‡ç”¨ä¸€ä¸ªæ±‚å’Œå…¬å¼å¾—åˆ°æœ€åçš„ç»“æœã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæ¯”å¦‚è¢«æ°´æ¨¡ç³Šæ‰çš„æ»‘æ¿ï¼Œä»¥åŠä¸¥é‡é®æŒ¡çš„å¤§è±¡ï¼‰

<div align='center'>
  <img src='resources/gfl.jpg' height="200" width="600">
</div>   

<div align='center'>
  <img src='resources/gfl-1.png' height="100" width="600">
</div>   

åœ¨nanodetçš„åŸå§‹å®ç°ä¸­ï¼ŒONNXå¯¼å‡ºæ—¶ï¼Œæ˜¯ä¸å¯¼å‡ºdistribution_projectéƒ¨åˆ†çš„ï¼ŒåŸæ¥çš„ä»£ç å¦‚ä¸‹ï¼š  
```python
# åŸæ¥çš„nanodet_head.pyä¸­onnxå¯¼å‡ºç›¸å…³çš„éƒ¨åˆ†  
if torch.onnx.is_in_onnx_export():
  cls_score = (
    torch.sigmoid(cls_score)
      .reshape(1, self.num_classes, -1)
      .permute(0, 2, 1)
  )
  bbox_pred = bbox_pred.reshape(1, (self.reg_max + 1) * 4, -1).permute(
    0, 2, 1
  )
return cls_score, bbox_pred
```
è€Œä¸”å¦‚æœç›´æ¥ä½¿ç”¨åŸæ¥çš„Internalå®ç°ï¼Œå°±ç®—å¯¼å‡ºäº†ä¹Ÿæ²¡æ³•ç”¨ã€‚äºæ˜¯ï¼Œå°±åªèƒ½åœ¨C++ä¾§æ‰‹åŠ¨æ’¸Softmaxå’ŒMatMulçš„é€»è¾‘ã€‚è¿™å¯¹äºæˆ‘è¿™ç§æ‡’äººæ¥è¯´ï¼Œæ˜¾ç„¶æ˜¯ä¸ªå™©æ¢¦ã€‚èƒ½ç”¨pythonæå®šçš„äº‹æƒ…ï¼Œå°±ä¸è¦ç”¨C++æ¥æäº†ã€‚åœ¨ç»è¿‡å¯¹Internalçš„ä¸€ç•ªä¿®æ”¹åï¼Œç°åœ¨å·²ç»å¯ä»¥æˆåŠŸåœ°å¯¼å‡ºdistribution_projectæ“ä½œäº†ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥åˆ©ç”¨æ¨ç†å¼•æ“æœ¬èº«å®ç°çš„Softmaxå’ŒMatMulç®—å­äº†ã€‚ä¿®æ”¹åçš„ä»£ç ä¸ºï¼š  
```python
if torch.onnx.is_in_onnx_export():
  cls_score = (
    torch.sigmoid(cls_score)
      .reshape(1, self.num_classes, -1)
      .permute(0, 2, 1)
  )
  bbox_pred = bbox_pred.reshape(1, (self.reg_max + 1) * 4, -1).permute(
    0, 2, 1
  )
  # åªéœ€è¦æ·»åŠ è¿™ä¸€å¥
  bbox_pred = self.distribution_project(bbox_pred).unsqueeze(0)
return cls_score, bbox_pred

```  
é‚£ä¹ˆï¼Œbbox_predå¯¼å‡ºåçš„ç»´åº¦æ˜¯(1,?=1600|400|100|...,4)ï¼Œè¿™é‡Œçš„?è¡¨ç¤ºçš„æ˜¯æ¡†çš„ä¸ªæ•°ï¼Œ4è¡¨ç¤ºçš„(l,t,r,b)ï¼Œå³åˆ†åˆ«æ¡†çš„å››æ¡è¾¹è·ç¦»ä¸­å¿ƒçš„è·ç¦»ï¼Œleftã€topã€rightå’Œbottomã€‚å¯¼å‡ºåçš„ONNXæ¨¡å‹æ–‡ä»¶çš„ç»“æ„å¦‚ä¸‹ï¼š  

<div align='center'>
  <img src='resources/nanodet-head.png' >
</div>   

å¯ä»¥çœ‹åˆ°ï¼Œdistribution_projectæ“ä½œå·²ç»è¢«è½¬æ¢æˆSoftmaxå’ŒMatMulä¸¤ä¸ªç®—å­ã€‚è€Œåœ¨Internalä¸­æ³¨å†Œçš„`project`ä¹Ÿè¢«å½“åšäº†å¸¸é‡ä½œä¸ºMatMulç®—å­çš„è¾“å…¥ã€‚  

<div align='center'>
  <img src='resources/matmul.png' height="400px" width="600">
</div>   



## 4. æ¥å£æ–‡æ¡£

åœ¨[lite.ai.toolkit](https://github.com/DefTruth/lite.ai.toolkit) ä¸­ï¼Œnanodetçš„å®ç°ç±»ä¸ºï¼š

```c++
class LITE_EXPORTS lite::cv::detection::NanoDet;
class LITE_EXPORTS lite::cv::detection::NanoDetEfficientNetLite;
class LITE_EXPORTS lite::mnn::cv::detection::NanoDet;
class LITE_EXPORTS lite::mnn::cv::detection::NanoDetEfficientNetLite;
class LITE_EXPORTS lite::tnn::cv::detection::NanoDet;
class LITE_EXPORTS lite::tnn::cv::detection::NanoDetEfficientNetLite;
class LITE_EXPORTS lite::ncnn::cv::detection::NanoDet;
class LITE_EXPORTS lite::ncnn::cv::detection::NanoDetEfficientNetLite;
```  
è¯¥ç±»å‹ç›®å‰åŒ…å«1å…¬å…±æ¥å£`detect`ç”¨äºè¿›è¡Œç›®æ ‡æ£€æµ‹ã€‚ç”±äºEfficientNetLiteç‰ˆæœ¬çš„nanodetå‰å¤„ç†å’Œå…¶ä»–ç‰ˆæœ¬çš„ä¸ä¸€è‡´ï¼Œæˆ‘ä¸ºäº†ä¿æŒLite.AI.ToolKitä¸­åˆå§‹åŒ–é£æ ¼çš„ä¸€è‡´æ€§ï¼Œè¿™é‡Œä½¿ç”¨ä¸¤ä¸ªç±»åˆ†åˆ«å®ç°äº†nanodetçš„C++å°è£…ã€‚
```c++
public:
    /**
     * @param mat cv::Mat BGR format
     * @param detected_boxes vector of Boxf to catch detected boxes.
     * @param score_threshold default 0.45f, only keep the result which >= score_threshold.
     * @param iou_threshold default 0.3f, iou threshold for NMS.
     * @param topk default 100, maximum output boxes after NMS.
     * @param nms_type the method.
     */
    void detect(const cv::Mat &mat, std::vector<types::Boxf> &detected_boxes,
                float score_threshold = 0.45f, float iou_threshold = 0.3f,
                unsigned int topk = 100, unsigned int nms_type = NMS::OFFSET);
```
`detect`æ¥å£çš„è¾“å…¥å‚æ•°è¯´æ˜ï¼š  
* mat: cv::Matç±»å‹ï¼ŒBGRæ ¼å¼ã€‚  
* detected_boxes: Boxfå‘é‡ï¼ŒåŒ…å«è¢«æ£€æµ‹åˆ°çš„æ¡†ï¼ŒBoxfä¸­åŒ…å«x1,y1,x2,y2,label,scoreç­‰æˆå‘˜  
* score_thresholdï¼šåˆ†ç±»å¾—åˆ†ï¼ˆè´¨é‡å¾—åˆ†ï¼‰é˜ˆå€¼ï¼Œé»˜è®¤0.45ï¼Œå°äºè¯¥é˜ˆå€¼çš„æ¡†å°†è¢«ä¸¢å¼ƒã€‚  
* iou_thresholdï¼šNMSä¸­çš„ioué˜ˆå€¼ï¼Œé»˜è®¤0.3ã€‚
* topkï¼šé»˜è®¤100ï¼Œåªä¿ç•™å‰kä¸ªæ£€æµ‹åˆ°çš„ç»“æœã€‚
* nms_typeï¼šNMSç®—æ³•çš„ç±»å‹ï¼Œé»˜è®¤ä¸ºä¸åŒçš„ç±»åˆ«å„è‡ªåšNMSã€‚ 

## 5. ä½¿ç”¨æ¡ˆä¾‹
è¿™é‡Œæµ‹è¯•ä½¿ç”¨çš„æ˜¯nanodet_m.onnxç‰ˆæœ¬çš„æ¨¡å‹ï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨å…¶ä»–ç‰ˆæœ¬çš„æ¨¡å‹ã€‚  

### 5.1 ONNXRuntimeç‰ˆæœ¬
```c++
#include "lite/lite.h"

static void test_nanodet()
{
    std::string onnx_path = "../hub/onnx/cv/nanodet_m.onnx";
    std::string test_img_path = "../resources/9.jpg";
    std::string save_img_path = "../logs/9.jpg";
    
    auto *nanodet = new lite::cv::detection::NanoDet(onnx_path);
    
    std::vector<lite::types::Boxf> detected_boxes;
    cv::Mat img_bgr = cv::imread(test_img_path);
    nanodet->detect(img_bgr, detected_boxes, 0.3f);
    
    lite::utils::draw_boxes_inplace(img_bgr, detected_boxes);
    
    cv::imwrite(save_img_path, img_bgr);
    
    std::cout << "Detected Boxes Num: " << detected_boxes.size() << std::endl;
    
    delete nanodet;

}
```  
### 5.2 MNNç‰ˆæœ¬
```c++
#ifdef ENABLE_MNN
    std::string mnn_path = "../hub/mnn/cv/nanodet_m.mnn";
    std::string test_img_path = "../examples/lite/resources/9.jpg";
    std::string save_img_path = "../logs/9_mnn_2.jpg";
    
    // 3. Test Specific Engine MNN
    lite::mnn::cv::detection::NanoDet *nanodet =
    new lite::mnn::cv::detection::NanoDet(mnn_path);
    
    std::vector<lite::types::Boxf> detected_boxes;
    cv::Mat img_bgr = cv::imread(test_img_path);
    nanodet->detect(img_bgr, detected_boxes);
    
    lite::utils::draw_boxes_inplace(img_bgr, detected_boxes);
    cv::imwrite(save_img_path, img_bgr);
    
    std::cout << "MNN Version Detected Boxes Num: " << detected_boxes.size() << std::endl;
    
    delete nanodet;
#endif
```  

### 5.3 TNNç‰ˆæœ¬
```c++
#ifdef ENABLE_TNN
    std::string proto_path = "../hub/tnn/cv/nanodet_m.opt.tnnproto";
    std::string model_path = "../hub/tnn/cv/nanodet_m.opt.tnnmodel";
    std::string test_img_path = "../examples/lite/resources/9.jpg";
    std::string save_img_path = "../logs/9_tnn_2.jpg";
    
    // 4. Test Specific Engine TNN
    lite::tnn::cv::detection::NanoDet *nanodet =
    new lite::tnn::cv::detection::NanoDet(proto_path, model_path);
    
    std::vector<lite::types::Boxf> detected_boxes;
    cv::Mat img_bgr = cv::imread(test_img_path);
    nanodet->detect(img_bgr, detected_boxes);
    
    lite::utils::draw_boxes_inplace(img_bgr, detected_boxes);
    cv::imwrite(save_img_path, img_bgr);
    
    std::cout << "TNN Version Detected Boxes Num: " << detected_boxes.size() << std::endl;
    
    delete nanodet;
#endif
```  

### 5.4 NCNNç‰ˆæœ¬
```c++
#ifdef ENABLE_NCNN
    std::string param_path = "../hub/ncnn/cv/nanodet_m-opt.param";
    std::string bin_path = "../hub/ncnn/cv/nanodet_m-opt.bin";
    std::string test_img_path = "../examples/lite/resources/9.jpg";
    std::string save_img_path = "../logs/9_ncnn_2.jpg";
    
    // 4. Test Specific Engine NCNN
    lite::ncnn::cv::detection::NanoDet *nanodet =
    new lite::ncnn::cv::detection::NanoDet(
    param_path, bin_path,1, 320, 320);
    
    std::vector<lite::types::Boxf> detected_boxes;
    cv::Mat img_bgr = cv::imread(test_img_path);
    nanodet->detect(img_bgr, detected_boxes);
    
    lite::utils::draw_boxes_inplace(img_bgr, detected_boxes);
    cv::imwrite(save_img_path, img_bgr);
    
    std::cout << "NCNN Version Detected Boxes Num: " << detected_boxes.size() << std::endl;
    
    delete nanodet;
#endif
```  
* è¾“å‡ºç»“æœä¸º:  
<div align='center'>
  <img src='resources/1.jpg' height="100px" width="200px">
  <img src='resources/2.jpg' height="100px" width="200px">
  <img src='resources/3.jpg' height="100px" width="200px">
  <img src='resources/4.jpg' height="100px" width="200px">
  <br>  
  <img src='resources/5.jpg' height="100px" width="200px">
  <img src='resources/6.jpg' height="100px" width="200px">
  <img src='resources/7.jpg' height="100px" width="200px">
  <img src='resources/9.jpg' height="100px" width="200px">
</div>   

## 6. ç¼–è¯‘è¿è¡Œ
åœ¨MacOSä¸‹å¯ä»¥ç›´æ¥ç¼–è¯‘è¿è¡Œæœ¬é¡¹ç›®ï¼Œæ— éœ€ä¸‹è½½å…¶ä»–ä¾èµ–åº“ã€‚å…¶ä»–ç³»ç»Ÿåˆ™éœ€è¦ä»[lite.ai.toolkit](https://github.com/DefTruth/lite.ai.toolkit) ä¸­ä¸‹è½½æºç å…ˆç¼–è¯‘*lite.ai.toolkit.v0.1.0*åŠ¨æ€åº“ã€‚
```shell
git clone --depth=1 https://github.com/DefTruth/nanodet.lite.ai.toolkit.git
cd nanodet.lite.ai.toolkit 
sh ./build.sh
```  

* CMakeLists.txtè®¾ç½®
```cmake
cmake_minimum_required(VERSION 3.17)
project(nanodet.lite.ai.toolkit)

set(CMAKE_CXX_STANDARD 11)

# setting up lite.ai.toolkit
set(LITE_AI_DIR ${CMAKE_SOURCE_DIR}/lite.ai.toolkit)
set(LITE_AI_INCLUDE_DIR ${LITE_AI_DIR}/include)
set(LITE_AI_LIBRARY_DIR ${LITE_AI_DIR}/lib)
include_directories(${LITE_AI_INCLUDE_DIR})
link_directories(${LITE_AI_LIBRARY_DIR})

set(OpenCV_LIBS
        opencv_highgui
        opencv_core
        opencv_imgcodecs
        opencv_imgproc
        opencv_video
        opencv_videoio
        )
# add your executable
set(EXECUTABLE_OUTPUT_PATH ${CMAKE_SOURCE_DIR}/examples/build)

add_executable(lite_nanodet examples/test_lite_nanodet.cpp)
target_link_libraries(lite_nanodet
        lite.ai.toolkit
        onnxruntime
        MNN  # need, if built lite.ai.toolkit with ENABLE_MNN=ON,  default OFF
        ncnn # need, if built lite.ai.toolkit with ENABLE_NCNN=ON, default OFF
        TNN  # need, if built lite.ai.toolkit with ENABLE_TNN=ON,  default OFF
        ${OpenCV_LIBS})  # link lite.ai.toolkit & other libs.
```

* building && testing information:
```shell
--- Build files have been written to: /Users/xxx/Desktop/xxx/nanodet.lite.ai.toolkit/examples/build
[ 50%] Building CXX object CMakeFiles/lite_nanodet.dir/examples/test_lite_nanodet.cpp.o
[100%] Linking CXX executable lite_nanodet
[100%] Built target lite_nanodet
Testing Start ...
LITEORT_DEBUG LogId: ../hub/onnx/cv/nanodet_m.onnx
=============== Input-Dims ==============
input_node_dims: 1
input_node_dims: 3
input_node_dims: 320
input_node_dims: 320
=============== Output-Dims ==============
Output: 0 Name: cls_pred_stride_8 Dim: 0 :1
Output: 0 Name: cls_pred_stride_8 Dim: 1 :1600
Output: 0 Name: cls_pred_stride_8 Dim: 2 :80
Output: 1 Name: cls_pred_stride_16 Dim: 0 :1
Output: 1 Name: cls_pred_stride_16 Dim: 1 :400
Output: 1 Name: cls_pred_stride_16 Dim: 2 :80
Output: 2 Name: cls_pred_stride_32 Dim: 0 :1
Output: 2 Name: cls_pred_stride_32 Dim: 1 :100
Output: 2 Name: cls_pred_stride_32 Dim: 2 :80
Output: 3 Name: dis_pred_stride_8 Dim: 0 :1
Output: 3 Name: dis_pred_stride_8 Dim: 1 :1600
Output: 3 Name: dis_pred_stride_8 Dim: 2 :4
Output: 4 Name: dis_pred_stride_16 Dim: 0 :1
Output: 4 Name: dis_pred_stride_16 Dim: 1 :400
Output: 4 Name: dis_pred_stride_16 Dim: 2 :4
Output: 5 Name: dis_pred_stride_32 Dim: 0 :1
Output: 5 Name: dis_pred_stride_32 Dim: 1 :100
Output: 5 Name: dis_pred_stride_32 Dim: 2 :4
generate_bboxes num: 50
Detected Boxes Num: 9
Testing Successful !
```  

![](resources/9.jpg)